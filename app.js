const API_URL='https://script.google.com/macros/s/AKfycbxkd82t9NGFfboV2FDy7klyIyLoBK-3Vlzo7z9vNEUVabG5EsEP3SqJuiOyRfs5zeFeMw/exec',EDIT_PASS='1990',PHOTO_ROOT_URL='https://drive.google.com/drive/folders/1zk8c6qGUBNcVQAUlucU5cedBKIQNu5GZ',photoStages=new Set(['hdf','prisadka','upakovka']);const orderInput=document.getElementById('order'),workerInput=document.getElementById('worker'),statusEl=document.getElementById('status'),video=document.getElementById('video'),canvas=document.getElementById('canvas'),ctx=canvas.getContext('2d',{willReadFrequently:!0}),startBtn=document.getElementById('startCam'),msg=document.getElementById('msg'),stageTitle=document.getElementById('stageTitle'),scanOverlay=document.getElementById('scanOverlay'),mainView=document.getElementById('mainView'),reportsView=document.getElementById('reportsView'),openReportsBtn=document.getElementById('openReports'),closeReportsBtn=document.getElementById('closeReports'),reportsStatus=document.getElementById('reportsStatus'),reportsTableBody=document.querySelector('#reportsTable tbody'),editReportsBtn=document.getElementById('editReports'),openPhotoStoreBtn=document.getElementById('openPhotoStore'),searchInput=document.getElementById('searchInput'),sortSelect=document.getElementById('sortSelect'),statsDate=document.getElementById('statsDate'),statsStage=document.getElementById('statsStage'),statsBtn=document.getElementById('statsBtn'),statsResult=document.getElementById('statsResult'),pdfFrom=document.getElementById('pdfFrom'),pdfTo=document.getElementById('pdfTo'),exportPdfBtn=document.getElementById('exportPdf'),printArea=document.getElementById('printArea'),pager=document.getElementById('pager');let page=1;const perPage=20;let stream=null,locked=!1,starting=!1,stopTimer=null,editMode=!1,rawReports=[],currentReports=[],filterTerm='',sortMode='time_desc',reportsTimer=null,reportsLoading=!1,currentFilter='day',reportsReqId=0;const deletedTombstones=new Map;function reportKey(r){return[String(r.db||''),String(r.order||''),String(r.stage||''),String(r.name||''),String(r.ts||''),String(r.date||''),String(r.time||'')].join('|')}function reportId(r){return reportKey(r)}function showScanOverlay(order){scanOverlay&&(scanOverlay.textContent='Готово: '+order,scanOverlay.classList.remove('hidden'))}function hideScanOverlay(){scanOverlay&&scanOverlay.classList.add('hidden')}function isStreamActive(){return stream&&stream.getTracks().some(t=>'live'===t.readyState)}function showScanButton(show){startBtn.style.display=show?'block':'none'}function stopCamera(){stream&&stream.getTracks().forEach(t=>t.stop()),stream=null,stopTimer&&(clearTimeout(stopTimer),stopTimer=null),showScanButton(!0)}function freezeCamera(){stream&&stream.getTracks().forEach(t=>t.stop()),locked=!0,stopTimer&&(clearTimeout(stopTimer),stopTimer=null),showScanButton(!0)}const savedName=localStorage.getItem('workerName')||'';savedName&&(workerInput.value=savedName),workerInput.addEventListener('input',()=>localStorage.setItem('workerName',workerInput.value.trim()));function parseDbOrderClient(raw){const s=String(raw||'').trim();if(s.includes('|')){const parts=s.split('|');return{db:parts[0].trim(),order:parts.slice(1).join('|').trim()}}return{db:'',order:s}}async function startCamera(){if(starting)return;starting=!0;try{stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'},width:{ideal:1280},height:{ideal:720}},audio:!1})}catch(e1){try{stream=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1})}catch(e2){msg.innerHTML='Камера не запустилась. Проверьте HTTPS, доступ и закрытие других приложений.',console.log(e1,e2),showScanButton(!0),starting=!1;return}}try{video.srcObject=stream,await video.play(),locked=!1,hideScanOverlay(),showScanButton(!1),stopTimer&&clearTimeout(stopTimer),stopTimer=setTimeout(()=>{locked||(msg.innerHTML='Сканирование остановлено. Нажмите «СКАНИРОВАТЬ».',stopCamera())},2e4),scan()}catch(e3){msg.innerHTML='Не удалось запустить видео. Обновите страницу и попробуйте снова.',console.log(e3)}finally{starting=!1}}startBtn.addEventListener('click',startCamera);function callApi(params,cb,onError){const cbName='cb_'+Math.random().toString(36).slice(2);let done=!1;window[cbName]=function(){};const timeout=setTimeout(()=>{done||(done=!0,onError&&onError('⚠️ Нет ответа от сервера'))},12e3);window[cbName]=function(res){done||(done=!0,clearTimeout(timeout),cb(res),setTimeout(()=>{delete window[cbName]},3e4))};const query=new URLSearchParams(params);query.set('api','1'),query.set('callback',cbName),query.set('_ts',Date.now().toString());const script=document.createElement('script');script.src=API_URL+'?'+query.toString(),script.onerror=()=>{done||(done=!0,clearTimeout(timeout),onError&&onError('⚠️ Ошибка связи с сервером'))},document.body.appendChild(script)}function flashStage(btn){btn.classList.add('stage-active'),setTimeout(()=>btn.classList.remove('stage-active'),700)}function sendStage(stage,color,btn,photoUrl,facades){const parsed=parseDbOrderClient(orderInput.value);let raw=parsed.order,db=parsed.db,name=workerInput.value.trim();if(!raw)return void(statusEl.innerHTML='Введите/сканируйте номер');if(!name)return void(statusEl.innerHTML='Введите имя');btn&&flashStage(btn),statusEl.innerHTML='Отправка...',callApi({action:'mark',stage,order:raw,name,color:color||'',db,photo_url:photoUrl||'',facades:!0===facades?'1':!1===facades?'0':''},res=>{statusEl.innerHTML=res.ok?'✅ Готово':'⚠️ '+res.msg},err=>{statusEl.innerHTML=err})}const hasBarcodeDetector='BarcodeDetector'in window,detector=hasBarcodeDetector?new BarcodeDetector({formats:['qr_code']}):null;function scan(){if(!locked)if(isStreamActive()){if(hasBarcodeDetector)return void detector.detect(video).then(codes=>{if(codes&&codes.length){const data=codes[0].rawValue||'';orderInput.value=data,msg.innerHTML='✅ Готово!',navigator.vibrate&&navigator.vibrate(80),showScanOverlay(data),freezeCamera()}else requestAnimationFrame(scan)}).catch(()=>requestAnimationFrame(scan));if(video.readyState===video.HAVE_ENOUGH_DATA){canvas.width=video.videoWidth,canvas.height=video.videoHeight,ctx.drawImage(video,0,0,canvas.width,canvas.height);const imageData=ctx.getImageData(0,0,canvas.width,canvas.height),code=jsQR(imageData.data,imageData.width,imageData.height,{inversionAttempts:'attemptBoth'});if(code)return orderInput.value=code.data,msg.innerHTML='✅ Готово!',navigator.vibrate&&navigator.vibrate(80),showScanOverlay(code.data),void freezeCamera()}requestAnimationFrame(scan)}else startCamera()}const params=new URLSearchParams(location.search),only=(params.get('only')||'').toLowerCase(),view=(params.get('view')||'').toLowerCase();document.querySelectorAll('#stageButtons button').forEach(btn=>{const stage=btn.dataset.stage,key=(btn.dataset.only||stage).toLowerCase(),color=btn.dataset.color||'';btn.onclick=()=>{photoStages.has(stage)?openPhotoDialog(stage,color,btn):sendStage(stage,color,btn,'')},only&&key!==only&&(btn.style.display='none')}),only&&(stageTitle.textContent='Этап:');function openFacadesDialog(onChoose){const overlay=document.createElement('div');overlay.id='facadesOverlay',overlay.innerHTML='<div class="photo-modal"><div class="photo-title">ФАСАДЫ</div><div class="small">Есть фасады для окраски?</div><div class="photo-actions" style="margin-top:12px;"><button id="facadesYes">ЕСТЬ</button><button id="facadesNo">НЕТ</button></div><div id="facadesMsg" class="small"></div></div>',document.body.appendChild(overlay),document.getElementById('facadesYes').onclick=()=>{overlay.remove(),onChoose(!0)},document.getElementById('facadesNo').onclick=()=>{overlay.remove(),onChoose(!1)}}function openPhotoDialog(stage,color,btn){const overlay=document.createElement('div');overlay.id='photoOverlay',overlay.innerHTML='<div class="photo-modal"><div class="photo-title">Загрузите фото для этапа</div><input id="photoInput" type="file" accept="image/*" multiple /><div class="photo-actions"><button id="photoUpload">Загрузить</button><button id="photoSkip">Продолжить без фото</button><button id="photoCancel">Отмена</button></div><div id="photoMsg" class="small"></div></div>',document.body.appendChild(overlay);const input=document.getElementById('photoInput'),msgEl=document.getElementById('photoMsg');document.getElementById('photoCancel').onclick=()=>overlay.remove(),document.getElementById('photoSkip').onclick=()=>{overlay.remove(),'prisadka'===stage?openFacadesDialog(hasFacades=>{sendStage(stage,color,btn,'',hasFacades)}):sendStage(stage,color,btn,'')},document.getElementById('photoUpload').onclick=async()=>{const files=Array.from(input.files||[]);if(!files.length)return void(msgEl.textContent='Выберите фото');msgEl.textContent='Загрузка...';const folderUrl=await uploadPhotos(files,stage).catch(err=>(msgEl.textContent=err,null));folderUrl&&(overlay.remove(),'prisadka'===stage?openFacadesDialog(hasFacades=>{sendStage(stage,color,btn,folderUrl,hasFacades)}):sendStage(stage,color,btn,folderUrl))}}async function uploadPhotos(files,stage){const parsed=parseDbOrderClient(orderInput.value),order=parsed.order,db=parsed.db,name=workerInput.value.trim();if(!order||!name)throw'Введите заказ и имя';const now=new Date,date=now.toLocaleDateString('ru-RU'),time=now.toTimeString().slice(0,5),payload={action:'upload_photos',order,stage,name,date,time,db,files:[]};for(const f of files){const item=await fileToPayload(f);payload.files.push(item)}const res=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(payload)}).then(r=>r.json());if(!res.ok)throw res.msg||'Ошибка загрузки';return res.folderUrl}async function fileToPayload(file){const MAX_SIZE=1600,QUALITY=.8;try{const img=await loadImage(file);let w=img.width,h=img.height;Math.max(w,h)>MAX_SIZE&&(w>=h?(h=Math.round(h*(MAX_SIZE/w)),w=MAX_SIZE):(w=Math.round(w*(MAX_SIZE/h)),h=MAX_SIZE));const canvas=document.createElement('canvas');canvas.width=w,canvas.height=h;const cctx=canvas.getContext('2d');cctx.drawImage(img,0,0,w,h);const blob=await canvasToBlob(canvas,'image/jpeg',QUALITY),data=await blobToBase64(blob),baseName=file.name.replace(/\.[^/.]+$/,'');return{name:baseName+'.jpg',type:'image/jpeg',data}}catch(e){const data=await fileToBase64(file);return{name:file.name,type:file.type,data}}}function loadImage(file){return new Promise((resolve,reject)=>{const url=URL.createObjectURL(file),img=new Image;img.onload=()=>{URL.revokeObjectURL(url),resolve(img)},img.onerror=()=>{URL.revokeObjectURL(url),reject('Ошибка загрузки изображения')},img.src=url})}function canvasToBlob(canvas,type,quality){return new Promise((resolve,reject)=>{canvas.toBlob(b=>{b?resolve(b):reject('Ошибка сжатия')},type,quality)})}function blobToBase64(blob){return new Promise((resolve,reject)=>{const r=new FileReader;r.onload=()=>resolve(r.result.split(',')[1]),r.onerror=()=>reject('Ошибка чтения'),r.readAsDataURL(blob)})}function fileToBase64(file){return new Promise((resolve,reject)=>{const r=new FileReader;r.onload=()=>resolve(r.result.split(',')[1]),r.onerror=()=>reject('Ошибка чтения файла'),r.readAsDataURL(file)})}function setActiveFilter(filter){document.querySelectorAll('.filters button').forEach(b=>{b.classList.toggle('active',b.dataset.filter===filter)})}function openReports(){mainView.classList.add('hidden'),reportsView.classList.remove('hidden'),currentFilter||(currentFilter='day'),setActiveFilter(currentFilter),loadReports(currentFilter,!0),reportsTimer&&clearInterval(reportsTimer),reportsTimer=setInterval(()=>{loadReports(currentFilter)},7e3)}function closeReports(){reportsView.classList.add('hidden'),mainView.classList.remove('hidden'),reportsTimer&&(clearInterval(reportsTimer),reportsTimer=null)}'reports'===view&&setTimeout(openReports,0);function loadReports(filter,force){if(force||!reportsLoading){reportsLoading=!0,currentFilter=filter;const reqId=++reportsReqId;callApi({action:'reports',filter},res=>{reqId===reportsReqId&&(reportsLoading=!1,res.ok?(rawReports=res.data||[],applyFilterSort(!1)):reportsStatus.textContent='⚠️ '+res.msg)},err=>{reqId===reportsReqId&&(reportsLoading=!1)})}}function applyFilterSort(resetPage){currentReports=rawReports.slice().filter(r=>!deletedTombstones.has(reportId(r)));const t=(filterTerm||'').toLowerCase().trim();t&&(currentReports=currentReports.filter(r=>{const line=(r.order+' '+r.date+' '+r.time+' '+r.stage+' '+r.name+' '+r.db).toLowerCase(),words=t.split(/\s+/).filter(Boolean);for(let i=0;i<words.length;i++)if(-1!==line.indexOf(words[i]))return!0;return!1})),currentReports.sort((a,b)=>compareReports(a,b,sortMode));const pages=Math.max(1,Math.ceil(currentReports.length/perPage));resetPage&&(page=1),page>pages&&(page=pages),reportsStatus.textContent='Найдено: '+currentReports.length+(t?' | Поиск: '+t:''),renderReports(),renderPager()}function compareReports(a,b,mode){const av=0===mode.indexOf('order')?a.order||'':0===mode.indexOf('db')?a.db||'':0===mode.indexOf('date')||0===mode.indexOf('time')?a.ts||0:'',bv=0===mode.indexOf('order')?b.order||'':0===mode.indexOf('db')?b.db||'':0===mode.indexOf('date')||0===mode.indexOf('time')?b.ts||0:'',asc=-1!==mode.indexOf('_asc');if('number'==typeof av)return asc?av-bv:bv-av;const s1=String(av).toLowerCase(),s2=String(bv).toLowerCase();return s1<s2?asc?-1:1:s1>s2?asc?1:-1:0}function renderReports(){reportsTableBody.innerHTML='';const start=(page-1)*perPage,end=start+perPage,slice=currentReports.slice(start,end);slice.forEach(r=>{const tr=document.createElement('tr'),orderTd=document.createElement('td'),dateTd=document.createElement('td'),timeTd=document.createElement('td'),stageTd=document.createElement('td'),nameTd=document.createElement('td'),dbTd=document.createElement('td'),actionTd=document.createElement('td');orderTd.textContent=r.order,dateTd.textContent=r.date,timeTd.textContent=r.time,stageTd.textContent=r.stage,nameTd.textContent=r.name,dbTd.textContent=r.db||'',editMode&&(()=>{const btn=document.createElement('button');btn.textContent='Удалить',actionTd.classList.add('row-actions'),actionTd.appendChild(btn);const key=reportId(r);btn.onclick=()=>{confirm('Удалить строку?')&&callApi({action:'delete_report',db:r.db,row:r.row},res=>{res.ok?(deletedTombstones.set(key,Date.now()),rawReports=rawReports.filter(x=>reportId(x)!==key),currentReports=currentReports.filter(x=>reportId(x)!==key),applyFilterSort(!1),reportsStatus.textContent='✅ Удалено'):reportsStatus.textContent='⚠️ '+res.msg},()=>{})}})(),tr.append(orderTd,dateTd,timeTd,stageTd,nameTd,dbTd,actionTd),reportsTableBody.appendChild(tr)})}function renderPager(){if(!pager)return;pager.innerHTML='';const total=currentReports.length,pages=Math.ceil(total/perPage);if(pages<=1)return;const prev=document.createElement('button');prev.textContent='←',prev.disabled=page<=1,prev.onclick=()=>{page--,renderReports(),renderPager()},pager.appendChild(prev);for(let i=1;i<=pages;i++){const b=document.createElement('button');b.textContent=i,i===page&&b.classList.add('active'),b.onclick=()=>{page=i,renderReports(),renderPager()},pager.appendChild(b)}const next=document.createElement('button');next.textContent='→',next.disabled=page>=pages,next.onclick=()=>{page++,renderReports(),renderPager()},pager.appendChild(next)}document.querySelectorAll('.filters button').forEach(btn=>{btn.onclick=()=>{const f=btn.dataset.filter;currentFilter=f,setActiveFilter(f),loadReports(f,!0),reportsTimer&&clearInterval(reportsTimer),reportsTimer=setInterval(()=>{loadReports(currentFilter)},7e3),page=1}}),searchInput.addEventListener('input',()=>{filterTerm=searchInput.value.trim(),applyFilterSort(!0)}),sortSelect.onchange=()=>{sortMode=sortSelect.value,applyFilterSort(!0)},statsBtn.onclick=()=>{const d=statsDate.value,stage=statsStage.value;if(!d)return void(statsResult.textContent='Выберите дату');statsResult.textContent='Считаю...',callApi({action:'reports',filter:'all'},res=>{if(!res.ok)return void(statsResult.textContent='Ошибка');const prefix=d.split('-');if(3!==prefix.length)return void(statsResult.textContent='Ошибка даты');const datePrefix=prefix[2]+'.'+prefix[1]+'.'+prefix[0].slice(-2),cnt=new Set((res.data||[]).filter(r=>String(r.date||'').startsWith(datePrefix)&&(stage==='all'||String(r.stage||'').toLowerCase()===stage)).map(r=>String(r.order||'').trim())).size;statsResult.textContent='Уникальных заказов: '+cnt},()=>{statsResult.textContent='Нет ответа'})};function parseYmdToMs(ymd){if(!ymd)return'';const p=ymd.split('-');if(3!==p.length)return'';const y=parseInt(p[0],10),m=parseInt(p[1],10),d=parseInt(p[2],10);return new Date(y,m-1,d,0,0,0).getTime()}function escapeHtml(str){return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;')}async function loadImageAsDataURL(url){const res=await fetch(url,{mode:'cors'}),blob=await res.blob();return await new Promise(resolve=>{const reader=new FileReader;reader.onload=()=>resolve(reader.result),reader.readAsDataURL(blob)})}function buildSummary(data){const map=new Map;data.forEach(r=>{const stage=String(r.stage||'').trim(),date=String(r.date||'').trim(),name=String(r.name||'').trim();if(stage&&date&&name){const key=stage+'|'+date+'|'+name;map.has(key)||map.set(key,{stage,date,name,orders:new Set});const order=String(r.order||'').trim();order&&map.get(key).orders.add(order)}});const rows=Array.from(map.values()).map(x=>({stage:x.stage,date:x.date,name:x.name,count:x.orders.size,orders:Array.from(x.orders).join(', ')}));return rows.sort((a,b)=>{const d=a.date.localeCompare(b.date,'ru');if(0!==d)return d;const s=a.stage.localeCompare(b.stage,'ru');return0!==s?s:a.name.localeCompare(b.name,'ru')}),rows}exportPdfBtn.onclick=async()=>{const fromMs=parseYmdToMs(pdfFrom.value),toMs=parseYmdToMs(pdfTo.value),toEnd=null!==toMs?toMs+864e5-1:null;let data=rawReports.slice();fromMs&&(data=data.filter(r=>Number(r.ts||0)>=fromMs)),toEnd&&(data=data.filter(r=>Number(r.ts||0)<=toEnd));if(!data.length)return void alert('Нет данных для выбранного периода');const summaryRows=buildSummary(data),period=(pdfFrom.value||'')+(pdfTo.value?' — '+pdfTo.value:''),logoUrl='https://s.fstl.ai/workers/nano/image_1770296525645_6vc4s2.png',logoData=await loadImageAsDataURL(logoUrl).catch(()=>''),rowsHtml=data.map(r=>`\n <tr>\n <td style="border:1px solid #bbb;padding:6px5px;">${escapeHtml(r.order||'')}</td>\n <td style="border:1px solid #bbb;padding:6px5px;">${escapeHtml(r.date||'')}</td>\n <td style="border:1px solid #bbb;padding:6px5px;">${escapeHtml(r.time||'')}</td>\n <td style="border:1px solid #bbb;padding:6px5px;">${escapeHtml(r.stage||'')}</td>\n <td style="border:1px solid #bbb;padding:6px5px;">${escapeHtml(r.name||'')}</td>\n <td style="border:1px solid #bbb;padding:6px5px;">${escapeHtml(r.db||'')}</td>\n </tr>\n `).join('');printArea.innerHTML=`\n<div style="width:794px; padding:28px30px; font-family:Arial, 'Segoe UI', sans-serif; box-sizing:border-box;">\n <div style="display:flex; align-items:center; gap:14px;">\n ${logoData?`<img src="${logoData}" style="width:320px;height:auto;object-fit:contain;">`:''}\n <div>\n <div style="font-size:20px;font-weight:700;">Отчёт ${period?'('+period+')':''}</div>\n <div style="font-size:12px;color:#555;">Сформировано: ${new Date().toLocaleString()}</div>\n </div>\n </div>\n\n <div style="margin-top:12px;font-size:12px;font-weight:700;">Сводка по сотрудникам:</div>\n <table style="width:100%;border-collapse:collapse;margin-top:6px;font-size:11px;">\n <thead>\n <tr>\n <th style="border:1px solid #bbb;padding:6px5px;background:#f2f2f2;">Этап</th>\n <th style="border:1px solid #bbb;padding:6px5px;background:#f2f2f2;">Дата</th>\n <th style="border:1px solid #bbb;padding:6px5px;background:#f2f2f2;">Сотрудник</th>\n <th style="border:1px solid #bbb;padding:6px5px;background:#f2f2f2;">Кол-во заказов</th>\n <th style="border:1px solid #bbb;padding:6px5px;background:#f2f2f2;">Номера заказов</th>\n </tr>\n </thead>\n <tbody>\n ${summaryRows.map(s=>`\n <tr>\n <td style="border:1px solid #bbb;padding:6px5px;">${escapeHtml(s.stage)}</td>\n <td style="border:1px solid #bbb;padding:6px5px;">${escapeHtml(s.date)}</td>\n <td style="border:1px solid #bbb;padding:6px5px;">${escapeHtml(s.name)}</td>\n <td style="border:1px solid #bbb;padding:6px5px;">${escapeHtml(String(s.count))}</td>\n <td style="border:1px solid #bbb;padding:6px5px;">${escapeHtml(s.orders)}</td>\n </tr>\n `).join('')}\n </tbody>\n </table>\n\n <table style="width:100%;border-collapse:collapse;margin-top:14px;font-size:12px;">\n <thead>\n <tr>\n <th style="border:1px solid #bbb;padding:6px5px;background:#f2f2f2;">Заказ</th>\n <th style="border:1px solid #bbb;padding:6px5px;background:#f2f2f2;">Дата</th>\n <th style="border:1px solid #bbb;padding:6px5px;background:#f2f2f2;">Время</th>\n <th style="border:1px solid #bbb;padding:6px5px;background:#f2f2f2;">Этап</th>\n <th style="border:1px solid #bbb;padding:6px5px;background:#f2f2f2;">Сотрудник</th>\n <th style="border:1px solid #bbb;padding:6px5px;background:#f2f2f2;">Таблица</th>\n </tr>\n </thead>\n <tbody>\n ${rowsHtml}\n </tbody>\n </table>\n</div>\n`;const fullCanvas=await html2canvas(printArea,{scale:2,useCORS:!0,backgroundColor:'#ffffff'}),{jsPDF}=window.jspdf,pdf=new jsPDF({unit:'mm',format:'a4',orientation:'portrait'}),pageWidth=210,pageHeight=297,pageHeightPx=Math.floor(fullCanvas.width*(pageHeight/pageWidth));let y=0,pageIndex=0;for(;y<fullCanvas.height;){const pageCanvas=document.createElement('canvas');pageCanvas.width=fullCanvas.width,pageCanvas.height=Math.min(pageHeightPx,fullCanvas.height-y);const pageCtx=pageCanvas.getContext('2d');pageCtx.fillStyle='#ffffff',pageCtx.fillRect(0,0,pageCanvas.width,pageCanvas.height),pageCtx.drawImage(fullCanvas,0,y,pageCanvas.width,pageCanvas.height,0,0,pageCanvas.width,pageCanvas.height);const imgData=pageCanvas.toDataURL('image/png'),imgHeightMm=pageCanvas.height/pageCanvas.width*pageWidth;pageIndex>0&&pdf.addPage(),pdf.addImage(imgData,'PNG',0,0,pageWidth,imgHeightMm),y+=pageHeightPx,pageIndex++}pdf.save('reports.pdf')},openReportsBtn.onclick=openReports,closeReportsBtn.onclick=closeReports,openPhotoStoreBtn&&(openPhotoStoreBtn.onclick=()=>window.open(PHOTO_ROOT_URL,'_blank')),editReportsBtn.onclick=()=>{const p=prompt('Пароль:');p===EDIT_PASS?(editMode=!editMode,editReportsBtn.textContent=editMode?'Выход':'Редактировать',renderReports()):alert('Неверный пароль')},document.getElementById('refreshBtn').onclick=async()=>{try{if('serviceWorker'in navigator){const regs=await navigator.serviceWorker.getRegistrations();regs.forEach(r=>r.unregister())}if(window.caches){const keys=await caches.keys();await Promise.all(keys.map(k=>caches.delete(k)))}}catch(e){}location.href=location.href.split('?')[0]+'?hard='+Date.now()};
